WITH stg AS
  (SELECT DISTINCT MD5 (COALESCE (AG_PROD_PLAN.AG_PROD_PLAN_ID::varchar(32), '-1')) AS AG_PROD_PLAN_H_ID,
                   AG_PROD_PLAN.LOAD_DT LOAD_DT,
                   AG_PROD_PLAN.CDC_DT DATA_EFF_STRT_DT,
                   AG_PROD_PLAN.DATA_SRC_NM DATA_SRC_NM,
                   AG_PROD_PLAN.DATA_STAT_CD DATA_STAT_CD,
                   AG_PROD_PLAN.CRE_DT SRC_CRE_DT,
                   AG_PROD_PLAN.LAST_CHG_DT SRC_LAST_CHG_DT,
                   AG_PROD_PLAN.LAST_CHG_USER_NM SRC_LAST_CHG_USER_NM,
                   AG_PROD_PLAN.DATA_IACTV_DT DATA_IACTV_DT,
                   AG_PROD_PLAN.FLD_ID FLD_ID,
                   AG_PROD_PLAN.NAP_UNIT_NBR NAP_UNIT_NBR,
                   AG_PROD_PLAN.NAP_UNIT_OVRRD_IND NAP_UNIT_OVRRD_IND,
                   AG_PROD_PLAN.CLU_ID CLU_ID,
                   AG_PROD_PLAN.GSPTL_AG_PROD_PLAN_ID GSPTL_AG_PROD_PLAN_ID,
                   AG_PROD_PLAN.CROP_PLNT_DT CROP_PLNT_DT,
                   AG_PROD_PLAN.CPLD_IND CPLD_IND,
                   AG_PROD_PLAN.SKIP_ROW_WDTH SKIP_ROW_WDTH,
                   AG_PROD_PLAN.CROP_ROW_WDTH CROP_ROW_WDTH,
                   AG_PROD_PLAN.CROP_ROW_CT CROP_ROW_CT,
                   AG_PROD_PLAN.SKIP_ROW_CT SKIP_ROW_CT,
                   AG_PROD_PLAN.TREE_SEP_LGTH TREE_SEP_LGTH,
                   AG_PROD_PLAN.TREE_AGE TREE_AGE,
                   AG_PROD_PLAN.TREE_UNIT_CT TREE_UNIT_CT,
                   AG_PROD_PLAN.ACRG_OFCL_MEAS_CD ACRG_OFCL_MEAS_CD,
                   AG_PROD_PLAN.DTER_ACRG_IND DTER_ACRG_IND,
                   AG_PROD_PLAN.CROP_RPT_UNIT_CD CROP_RPT_UNIT_CD,
                   AG_PROD_PLAN.CROP_FLD_DTER_QTY CROP_FLD_DTER_QTY,
                   AG_PROD_PLAN.CROP_FLD_RPT_QTY CROP_FLD_RPT_QTY,
                   AG_PROD_PLAN.CERT_DT CERT_DT,
                   AG_PROD_PLAN.PRNL_CROP_EXPR_YR PRNL_CROP_EXPR_YR,
                   AG_PROD_PLAN.LAND_USE_CD LAND_USE_CD,
                   AG_PROD_PLAN.PGM_YR PGM_YR,
                   AG_PROD_PLAN.ST_FSA_CD ST_FSA_CD,
                   AG_PROD_PLAN.CNTY_FSA_CD CNTY_FSA_CD,
                   AG_PROD_PLAN.TR_NBR TR_NBR,
                   AG_PROD_PLAN.FARM_NBR FARM_NBR,
                   AG_PROD_PLAN.FSA_CROP_TYPE_CD FSA_CROP_TYPE_CD,
                   AG_PROD_PLAN.FSA_CROP_CD FSA_CROP_CD,
                   AG_PROD_PLAN.CROP_INTN_USE_CD INTN_USE_CD,
                   AG_PROD_PLAN.PLNT_MULT_CROP_CD PLNT_MULT_CROP_CD,
                   AG_PROD_PLAN.PLNT_SCND_STAT_CD PLNT_SCND_STAT_CD,
                   AG_PROD_PLAN.PLNT_PRIM_STAT_CD PLNT_PRIM_STAT_CD,
                   AG_PROD_PLAN.PLNT_PTRN_TYPE_CD PLNT_PTRN_TYPE_CD,
                   AG_PROD_PLAN.CROP_PLNT_PCT CROP_PLNT_PCT,
                   AG_PROD_PLAN.CNCUR_PLNT_CD CNCUR_PLNT_CD,
                   AG_PROD_PLAN.CROP_USE_CD CROP_USE_CD,
                   AG_PROD_PLAN.COC_DAPRV_ACRG_IND COC_DAPRV_ACRG_IND,
                   AG_PROD_PLAN.OGNC_PRAC_TYPE_CD OGNC_PRAC_TYPE_CD,
                   AG_PROD_PLAN.NTV_PSTR_CVSN_IND NTV_PSTR_CVSN_IND,
                   AG_PROD_PLAN.CROP_PRAC_CD CROP_PRAC_CD,
                   AG_PROD_PLAN.CORE_PROD_CD CORE_PROD_CD,
                   AG_PROD_PLAN.CORE_PROD_TYPE_CD CORE_PROD_TYPE_CD,
                   AG_PROD_PLAN.PROD_INTN_USE_CD PROD_INTN_USE_CD,
                   AG_PROD_PLAN.ORGN_RPT_ACRG ORGN_RPT_ACRG,
                   AG_PROD_PLAN.RPT_ACRG_MOD_IND RPT_ACRG_MOD_IND,
                   AG_PROD_PLAN.RPT_ACRG_MOD_RSN_CD RPT_ACRG_MOD_RSN_CD,
                   AG_PROD_PLAN.RPT_ACRG_MOD_OT_RSN_TXT RPT_ACRG_MOD_OT_RSN_TXT,
                   AG_PROD_PLAN.ACRG_CALC_PRJ_CD ACRG_CALC_PRJ_CD,
                   AG_PROD_PLAN.ORGN_PLNT_DT ORGN_PLNT_DT,
                   AG_PROD_PLAN.PLNT_DT_MOD_IND PLNT_DT_MOD_IND,
                   AG_PROD_PLAN.PLNT_DT_MOD_RSN_CD PLNT_DT_MOD_RSN_CD,
                   AG_PROD_PLAN.PLNT_DT_MOD_OT_RSN_TXT PLNT_DT_MOD_OT_RSN_TXT,
                   AG_PROD_PLAN.CLU_PRDR_RVW_RQST_IND CLU_PRDR_RVW_RQST_IND,
                   AG_PROD_PLAN.CLU_TR_ID CLU_TR_ID,
                   AG_PROD_PLAN.AG_PROD_PLAN_ID AG_PROD_PLAN_ID,
                   AG_PROD_PLAN.PLNT_PRD_CD PLNT_PRD_CD,
                   AG_PROD_PLAN.IRR_PRAC_CD IRR_PRAC_CD,
                   AG_PROD_PLAN.FLD_NBR FLD_NBR,
                   AG_PROD_PLAN.SFLD_NBR SFLD_NBR,
                   AG_PROD_PLAN.ANML_UNIT_PUB_LAND_USE_PCT ANML_UNIT_PUB_LAND_USE_PCT,
                   AG_PROD_PLAN.ANML_UNIT_GRZ_BEG_DT ANML_UNIT_GRZ_BEG_DT,
                   AG_PROD_PLAN.ANML_UNIT_GRZ_END_DT ANML_UNIT_GRZ_END_DT,
                   AG_PROD_PLAN.SKIP_ROW_PTRN_CD SKIP_ROW_PTRN_CD,
                   AG_PROD_PLAN.MULT_CROP_INTN_USE_STAT_CD MULT_CROP_INTN_USE_STAT_CD,
                   AG_PROD_PLAN.ACTL_LAND_USE_CD ACTL_LAND_USE_CD,
                   AG_PROD_PLAN.CROP_LATE_FILE_IND CROP_LATE_FILE_IND,
                   AG_PROD_PLAN.NTV_PSTR_CVSN_OVRRD_IND NTV_PSTR_CVSN_OVRRD_IND,
				   AG_PROD_PLAN.PLNT_CNT PLNT_CT,
                   AG_PROD_PLAN.CDC_OPER_CD,
                   MD5 (AG_PROD_PLAN.AG_PROD_PLAN_ID || '~~' || TRIM (AG_PROD_PLAN.DATA_STAT_CD) || '~~' || TO_CHAR (AG_PROD_PLAN.CRE_DT, 'YYYY-MM-DD HH24:MI:SS.FF') || '~~' || TO_CHAR (AG_PROD_PLAN.LAST_CHG_DT, 'YYYY-MM-DD HH24:MI:SS.FF') || '~~' || TRIM (AG_PROD_PLAN.LAST_CHG_USER_NM) || '~~' || TO_CHAR (AG_PROD_PLAN.DATA_IACTV_DT, 'YYYY-MM-DD HH24:MI:SS.FF') || '~~' || TRIM (AG_PROD_PLAN.FLD_ID) || '~~' || TRIM (AG_PROD_PLAN.NAP_UNIT_NBR) || '~~' || TRIM (AG_PROD_PLAN.NAP_UNIT_OVRRD_IND) || '~~' || TRIM (AG_PROD_PLAN.CLU_ID) || '~~' || TRIM (AG_PROD_PLAN.GSPTL_AG_PROD_PLAN_ID) || '~~' || TO_CHAR (AG_PROD_PLAN.CROP_PLNT_DT, 'YYYY-MM-DD HH24:MI:SS') || '~~' || TRIM (AG_PROD_PLAN.CPLD_IND) || '~~' || AG_PROD_PLAN.SKIP_ROW_WDTH || '~~' || AG_PROD_PLAN.CROP_ROW_WDTH || '~~' || AG_PROD_PLAN.CROP_ROW_CT || '~~' || AG_PROD_PLAN.SKIP_ROW_CT || '~~' || AG_PROD_PLAN.TREE_SEP_LGTH || '~~' || AG_PROD_PLAN.TREE_AGE || '~~' || AG_PROD_PLAN.TREE_UNIT_CT || '~~' || TRIM (AG_PROD_PLAN.ACRG_OFCL_MEAS_CD) || '~~' || TRIM (AG_PROD_PLAN.DTER_ACRG_IND) || '~~' || TRIM (AG_PROD_PLAN.CROP_RPT_UNIT_CD) || '~~' || AG_PROD_PLAN.CROP_FLD_DTER_QTY || '~~' || AG_PROD_PLAN.CROP_FLD_RPT_QTY || '~~' || TO_CHAR (AG_PROD_PLAN.CERT_DT, 'YYYY-MM-DD HH24:MI:SS') || '~~' || AG_PROD_PLAN.PRNL_CROP_EXPR_YR || '~~' || TRIM (AG_PROD_PLAN.LAND_USE_CD) || '~~' || AG_PROD_PLAN.PGM_YR || '~~' || TRIM (AG_PROD_PLAN.ST_FSA_CD) || '~~' || TRIM (AG_PROD_PLAN.CNTY_FSA_CD) || '~~' || AG_PROD_PLAN.TR_NBR || '~~' || TRIM (AG_PROD_PLAN.FARM_NBR) || '~~' || TRIM (AG_PROD_PLAN.FSA_CROP_TYPE_CD) || '~~' || TRIM (AG_PROD_PLAN.FSA_CROP_CD) || '~~' || TRIM (AG_PROD_PLAN.CROP_INTN_USE_CD) || '~~' || TRIM (AG_PROD_PLAN.PLNT_MULT_CROP_CD) || '~~' || TRIM (AG_PROD_PLAN.PLNT_SCND_STAT_CD) || '~~' || TRIM (AG_PROD_PLAN.PLNT_PRIM_STAT_CD) || '~~' || TRIM (AG_PROD_PLAN.PLNT_PTRN_TYPE_CD) || '~~' || AG_PROD_PLAN.CROP_PLNT_PCT || '~~' || TRIM (AG_PROD_PLAN.CNCUR_PLNT_CD) || '~~' || TRIM (AG_PROD_PLAN.CROP_USE_CD) || '~~' || TRIM (AG_PROD_PLAN.COC_DAPRV_ACRG_IND) || '~~' || TRIM (AG_PROD_PLAN.OGNC_PRAC_TYPE_CD) || '~~' || TRIM (AG_PROD_PLAN.NTV_PSTR_CVSN_IND) || '~~' || AG_PROD_PLAN.CROP_PRAC_CD || '~~' || TRIM (AG_PROD_PLAN.CORE_PROD_CD) || '~~' || TRIM (AG_PROD_PLAN.CORE_PROD_TYPE_CD) || '~~' || TRIM (AG_PROD_PLAN.PROD_INTN_USE_CD) || '~~' || AG_PROD_PLAN.ORGN_RPT_ACRG || '~~' || TRIM (AG_PROD_PLAN.RPT_ACRG_MOD_IND) || '~~' || TRIM (AG_PROD_PLAN.RPT_ACRG_MOD_RSN_CD) || '~~' || TRIM (AG_PROD_PLAN.RPT_ACRG_MOD_OT_RSN_TXT) || '~~' || TRIM (AG_PROD_PLAN.ACRG_CALC_PRJ_CD) || '~~' || TO_CHAR (AG_PROD_PLAN.ORGN_PLNT_DT, 'YYYY-MM-DD HH24:MI:SS') || '~~' || TRIM (AG_PROD_PLAN.PLNT_DT_MOD_IND) || '~~' || TRIM (AG_PROD_PLAN.PLNT_DT_MOD_RSN_CD) || '~~' || TRIM (AG_PROD_PLAN.PLNT_DT_MOD_OT_RSN_TXT) || '~~' || TRIM (AG_PROD_PLAN.CLU_PRDR_RVW_RQST_IND) || '~~' || AG_PROD_PLAN.CLU_TR_ID || '~~' || AG_PROD_PLAN.AG_PROD_PLAN_ID || '~~' || TRIM (AG_PROD_PLAN.PLNT_PRD_CD) || '~~' || TRIM (AG_PROD_PLAN.IRR_PRAC_CD) || '~~' || TRIM (AG_PROD_PLAN.FLD_NBR) || '~~' || TRIM (AG_PROD_PLAN.SFLD_NBR) || '~~' || AG_PROD_PLAN.ANML_UNIT_PUB_LAND_USE_PCT || '~~' || TO_CHAR (AG_PROD_PLAN.ANML_UNIT_GRZ_BEG_DT, 'YYYY-MM-DD HH24:MI:SS.FF') || '~~' || TO_CHAR (AG_PROD_PLAN.ANML_UNIT_GRZ_END_DT, 'YYYY-MM-DD HH24:MI:SS.FF') || '~~' || TRIM (AG_PROD_PLAN.SKIP_ROW_PTRN_CD) || '~~' || TRIM (AG_PROD_PLAN.MULT_CROP_INTN_USE_STAT_CD) || '~~' || TRIM (AG_PROD_PLAN.ACTL_LAND_USE_CD) || '~~' || TRIM (AG_PROD_PLAN.CROP_LATE_FILE_IND) || '~~' || TRIM (AG_PROD_PLAN.NTV_PSTR_CVSN_OVRRD_IND)||'~~'||trim(AG_PROD_PLAN.PLNT_CT)) HASH_DIF
   FROM CARS_STG.AG_PROD_PLAN AG_PROD_PLAN
   WHERE AG_PROD_PLAN.CDC_OPER_CD = 'D'
     AND DATE (AG_PROD_PLAN.CDC_DT) = DATE (TO_TIMESTAMP ('{ETL_START_TIMESTAMP}', 'YYYY-MM-DD HH24:MI:SS.FF'))
     AND AG_PROD_PLAN.LOAD_DT = TO_TIMESTAMP (TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD'),
                                              'YYYY-MM-DD HH24:MI:SS.FF')
   ORDER BY AG_PROD_PLAN.CDC_DT),
     remainder AS
  (UPDATE edv.AG_PROD_PLAN_HS dv
   SET LOAD_END_DT = stg.LOAD_DT,
       DATA_EFF_END_DT = stg.DATA_EFF_STRT_DT
   FROM stg
   WHERE COALESCE (stg.AG_PROD_PLAN_ID,
                   0) = COALESCE (dv.AG_PROD_PLAN_ID,
                                  0)
     AND dv.LOAD_DT <> stg.LOAD_DT
     AND dv.LOAD_END_DT = TO_TIMESTAMP ('9999-12-31',
                                        'YYYY-MM-DD') RETURNING dv.*)
INSERT INTO edv.AG_PROD_PLAN_HS (AG_PROD_PLAN_H_ID, LOAD_DT, DATA_EFF_STRT_DT, DATA_SRC_NM, DATA_STAT_CD, SRC_CRE_DT, SRC_LAST_CHG_DT, SRC_LAST_CHG_USER_NM, DATA_IACTV_DT, FLD_ID, NAP_UNIT_NBR, NAP_UNIT_OVRRD_IND, CLU_ID, GSPTL_AG_PROD_PLAN_ID, CROP_PLNT_DT, CPLD_IND, SKIP_ROW_WDTH, CROP_ROW_WDTH, CROP_ROW_CT, SKIP_ROW_CT, TREE_SEP_LGTH, TREE_AGE, TREE_UNIT_CT, ACRG_OFCL_MEAS_CD, DTER_ACRG_IND, CROP_RPT_UNIT_CD, CROP_FLD_DTER_QTY, CROP_FLD_RPT_QTY, CERT_DT, PRNL_CROP_EXPR_YR, LAND_USE_CD, PGM_YR, ST_FSA_CD, CNTY_FSA_CD, TR_NBR, FARM_NBR, FSA_CROP_TYPE_CD, FSA_CROP_CD, INTN_USE_CD, PLNT_MULT_CROP_CD, PLNT_SCND_STAT_CD, PLNT_PRIM_STAT_CD, PLNT_PTRN_TYPE_CD, CROP_PLNT_PCT, CNCUR_PLNT_CD, CROP_USE_CD, COC_DAPRV_ACRG_IND, OGNC_PRAC_TYPE_CD, NTV_PSTR_CVSN_IND, CROP_PRAC_CD, CORE_PROD_CD, CORE_PROD_TYPE_CD, PROD_INTN_USE_CD, ORGN_RPT_ACRG, RPT_ACRG_MOD_IND, RPT_ACRG_MOD_RSN_CD, RPT_ACRG_MOD_OT_RSN_TXT, ACRG_CALC_PRJ_CD, ORGN_PLNT_DT, PLNT_DT_MOD_IND, PLNT_DT_MOD_RSN_CD, PLNT_DT_MOD_OT_RSN_TXT, CLU_PRDR_RVW_RQST_IND, CLU_TR_ID, AG_PROD_PLAN_ID, PLNT_PRD_CD, IRR_PRAC_CD, FLD_NBR, SFLD_NBR, ANML_UNIT_PUB_LAND_USE_PCT, ANML_UNIT_GRZ_BEG_DT, ANML_UNIT_GRZ_END_DT, SKIP_ROW_PTRN_CD, MULT_CROP_INTN_USE_STAT_CD, ACTL_LAND_USE_CD, CROP_LATE_FILE_IND, NTV_PSTR_CVSN_OVRRD_IND, PLNT_CT, DATA_EFF_END_DT, LOAD_END_DT, HASH_DIF)
SELECT stg.AG_PROD_PLAN_H_ID,
       stg.LOAD_DT,
       stg.DATA_EFF_STRT_DT,
       stg.DATA_SRC_NM,
       stg.DATA_STAT_CD,
       stg.SRC_CRE_DT,
       stg.SRC_LAST_CHG_DT,
       stg.SRC_LAST_CHG_USER_NM,
       stg.DATA_IACTV_DT,
       stg.FLD_ID,
       stg.NAP_UNIT_NBR,
       stg.NAP_UNIT_OVRRD_IND,
       stg.CLU_ID,
       stg.GSPTL_AG_PROD_PLAN_ID,
       stg.CROP_PLNT_DT,
       stg.CPLD_IND,
       stg.SKIP_ROW_WDTH,
       stg.CROP_ROW_WDTH,
       stg.CROP_ROW_CT,
       stg.SKIP_ROW_CT,
       stg.TREE_SEP_LGTH,
       stg.TREE_AGE,
       stg.TREE_UNIT_CT,
       stg.ACRG_OFCL_MEAS_CD,
       stg.DTER_ACRG_IND,
       stg.CROP_RPT_UNIT_CD,
       stg.CROP_FLD_DTER_QTY,
       stg.CROP_FLD_RPT_QTY,
       stg.CERT_DT,
       stg.PRNL_CROP_EXPR_YR,
       stg.LAND_USE_CD,
       stg.PGM_YR,
       stg.ST_FSA_CD,
       stg.CNTY_FSA_CD,
       stg.TR_NBR,
       stg.FARM_NBR,
       stg.FSA_CROP_TYPE_CD,
       stg.FSA_CROP_CD,
       stg.INTN_USE_CD,
       stg.PLNT_MULT_CROP_CD,
       stg.PLNT_SCND_STAT_CD,
       stg.PLNT_PRIM_STAT_CD,
       stg.PLNT_PTRN_TYPE_CD,
       stg.CROP_PLNT_PCT,
       stg.CNCUR_PLNT_CD,
       stg.CROP_USE_CD,
       stg.COC_DAPRV_ACRG_IND,
       stg.OGNC_PRAC_TYPE_CD,
       stg.NTV_PSTR_CVSN_IND,
       stg.CROP_PRAC_CD,
       stg.CORE_PROD_CD,
       stg.CORE_PROD_TYPE_CD,
       stg.PROD_INTN_USE_CD,
       stg.ORGN_RPT_ACRG,
       stg.RPT_ACRG_MOD_IND,
       stg.RPT_ACRG_MOD_RSN_CD,
       stg.RPT_ACRG_MOD_OT_RSN_TXT,
       stg.ACRG_CALC_PRJ_CD,
       stg.ORGN_PLNT_DT,
       stg.PLNT_DT_MOD_IND,
       stg.PLNT_DT_MOD_RSN_CD,
       stg.PLNT_DT_MOD_OT_RSN_TXT,
       stg.CLU_PRDR_RVW_RQST_IND,
       stg.CLU_TR_ID,
       stg.AG_PROD_PLAN_ID,
       stg.PLNT_PRD_CD,
       stg.IRR_PRAC_CD,
       stg.FLD_NBR,
       stg.SFLD_NBR,
       stg.ANML_UNIT_PUB_LAND_USE_PCT,
       stg.ANML_UNIT_GRZ_BEG_DT,
       stg.ANML_UNIT_GRZ_END_DT,
       stg.SKIP_ROW_PTRN_CD,
       stg.MULT_CROP_INTN_USE_STAT_CD,
       stg.ACTL_LAND_USE_CD,
       stg.CROP_LATE_FILE_IND,
       stg.NTV_PSTR_CVSN_OVRRD_IND,
	   stg.PLNT_CT,
       stg.DATA_EFF_STRT_DT,
       stg.LOAD_DT,
       stg.HASH_DIF
FROM stg
WHERE NOT EXISTS
    (SELECT '1'
     FROM remainder dv
     WHERE COALESCE (stg.AG_PROD_PLAN_ID,
                     0) = COALESCE (dv.AG_PROD_PLAN_ID,
                                    0) )
