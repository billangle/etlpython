MERGE  INTO EDV.TR_PRDR_YR_LS D
USING(SELECT DISTINCT MD5(coalesce(STG.CORE_CUST_ID,'-1')||'~~'||MD5(UPPER(coalesce(STG.ST_FSA_CD,'--')||'~~'||coalesce(STG.CNTY_FSA_CD,'--')||'~~'||coalesce(STG.FARM_NBR,'--')))||'~~'||MD5(UPPER(coalesce(STG.ST_FSA_CD,'--')||'~~'||coalesce(STG.CNTY_FSA_CD,'--')||'~~'||coalesce((STG.TR_NBR)::numeric ,-1)))) AS TR_PRDR_L_ID,coalesce(STG.TR_PRDR_YR_ID, '-1') TR_PRDR_YR_ID,STG.LOAD_DT LOAD_DT,STG.CDC_DT DATA_EFF_STRT_DT,STG.DATA_SRC_NM DATA_SRC_NM,STG.DATA_STAT_CD DATA_STAT_CD,STG.CRE_DT SRC_CRE_DT,STG.LAST_CHG_DT SRC_LAST_CHG_DT,STG.LAST_CHG_USER_NM SRC_LAST_CHG_USER_NM,STG.CORE_CUST_ID CORE_CUST_ID,STG.TR_YR_ID TR_YR_ID,STG.PRDR_INVL_CD SRC_PRDR_INVL_CD,PI.DMN_VAL_NM PRDR_INVL_NM,STG.PRDR_INVL_STRT_DT PRDR_INVL_STRT_DT,STG.PRDR_INVL_END_DT PRDR_INVL_END_DT,STG.PRDR_INVL_INTRPT_IND PRDR_INVL_INTRPT_IND,STG.TR_PRDR_HEL_EXCP_CD SRC_TR_PRDR_HEL_EXCP_CD,TPH.DMN_VAL_NM TR_PRDR_HEL_EXCP_NM,STG.TR_PRDR_CW_EXCP_CD SRC_TR_PRDR_CW_EXCP_CD,TPC.DMN_VAL_NM TR_PRDR_CW_EXCP_NM,STG.TR_PRDR_PCW_EXCP_CD SRC_TR_PRDR_PCW_EXCP_CD,TPP.DMN_VAL_NM TR_PRDR_PCW_EXCP_NM,STG.TM_PRD_ID TM_PRD_ID,STG.PGM_YR PGM_YR,STG.ST_FSA_CD ST_FSA_CD,STG.CNTY_FSA_CD CNTY_FSA_CD,STG.FARM_ID FARM_ID,STG.FARM_NBR FARM_NBR,STG.TR_NBR TR_NBR,STG.CDC_OPER_CD,
MD5(STG.CORE_CUST_ID||'~~'||UPPER(coalesce(STG.ST_FSA_CD,'--')||'~~'||coalesce(STG.CNTY_FSA_CD,'--')||'~~'||coalesce(STG.FARM_NBR,'--'))||'~~'||UPPER(coalesce(STG.ST_FSA_CD,'--')||'~~'||coalesce(STG.CNTY_FSA_CD,'--')||'~~'||coalesce((STG.TR_NBR)::numeric ,-1))||'~~'||STG.TR_PRDR_YR_ID||'~~'||trim(both STG.DATA_STAT_CD)||'~~'||TO_CHAR(STG.CRE_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||TO_CHAR(STG.LAST_CHG_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||trim(both STG.LAST_CHG_USER_NM)||'~~'||STG.CORE_CUST_ID||'~~'||STG.TR_YR_ID||'~~'||STG.PRDR_INVL_CD||'~~'||trim(both PI.DMN_VAL_NM)||'~~'||TO_CHAR(STG.PRDR_INVL_STRT_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||TO_CHAR(STG.PRDR_INVL_END_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||trim(both STG.PRDR_INVL_INTRPT_IND)||'~~'||STG.TR_PRDR_HEL_EXCP_CD||'~~'||trim(both TPH.DMN_VAL_NM)||'~~'||STG.TR_PRDR_CW_EXCP_CD||'~~'||trim(both TPC.DMN_VAL_NM)||'~~'||STG.TR_PRDR_PCW_EXCP_CD||'~~'||trim(both TPP.DMN_VAL_NM)||'~~'||STG.TM_PRD_ID||'~~'||STG.PGM_YR||'~~'||trim(both STG.ST_FSA_CD)||'~~'||trim(both STG.CNTY_FSA_CD)||'~~'||STG.FARM_ID||'~~'||trim(both STG.FARM_NBR)||'~~'||(trim(both STG.TR_NBR))::numeric ||'~~'||TO_CHAR(STG.HEL_APLS_EXHST_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||TO_CHAR(STG.CW_APLS_EXHST_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||TO_CHAR(STG.PCW_APLS_EXHST_DT,'YYYY-MM-DD HH24:MI:SS.US')||'~~'||STG.TR_PRDR_RMA_HEL_EXCP_CD||'~~'||STG.TR_PRDR_RMA_CW_EXCP_CD||'~~'||STG.TR_PRDR_RMA_PCW_EXCP_CD) HASH_DIF,STG.HEL_APLS_EXHST_DT,STG.CW_APLS_EXHST_DT,STG.PCW_APLS_EXHST_DT,STG.TR_PRDR_RMA_HEL_EXCP_CD,STG.TR_PRDR_RMA_CW_EXCP_CD,STG.TR_PRDR_RMA_PCW_EXCP_CD
FROM SQL_FARM_RCD_STG.TR_PRDR_YR STG
LEFT JOIN(SELECT * FROM EDV.PRDR_INVL_RS WHERE LOAD_END_DT=TO_TIMESTAMP('9999-12-31','YYYY-MM-DD')) PI
ON (STG.PRDR_INVL_CD=PI.DMN_VAL_ID)
LEFT JOIN(SELECT * FROM EDV.TR_PRDR_CW_EXCP_RS WHERE LOAD_END_DT=TO_TIMESTAMP('9999-12-31','YYYY-MM-DD')) TPC
ON (STG.TR_PRDR_CW_EXCP_CD=TPC.DMN_VAL_ID)
LEFT JOIN(SELECT * FROM EDV.TR_PRDR_HEL_EXCP_RS WHERE LOAD_END_DT=TO_TIMESTAMP('9999-12-31','YYYY-MM-DD')) TPH
ON (STG.TR_PRDR_HEL_EXCP_CD=TPH.DMN_VAL_ID)
LEFT JOIN(SELECT * FROM EDV.TR_PRDR_PCW_EXCP_RS WHERE LOAD_END_DT=TO_TIMESTAMP('9999-12-31','YYYY-MM-DD')) TPP
ON (STG.TR_PRDR_PCW_EXCP_CD=TPP.DMN_VAL_ID)
WHERE STG.CDC_OPER_CD IN ('I','UN')
ORDER BY STG.CDC_DT) S
ON (coalesce(S.TR_PRDR_YR_ID,0)=coalesce(D.TR_PRDR_YR_ID,0))
WHEN MATCHED AND D.LOAD_DT<>S.LOAD_DT AND D.LOAD_END_DT=TO_TIMESTAMP('9999-12-31','YYYY-MM-DD') AND S.HASH_DIF<>D.HASH_DIF THEN UPDATE 
SET LOAD_END_DT=S.LOAD_DT,
DATA_EFF_END_DT=S.DATA_EFF_STRT_DT
;